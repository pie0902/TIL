
# 동시성 제어에서 주문 취소 통보: Amazon SES를 활용한 메일 전송 전략

## Amazon SimpleEmailService란?

AWS Simple Email Service (SES)는 아마존 웹 서비스(AWS)가 제공하는 확장 가능한 이메일 전송 서비스다. 이 서비스는 기업이 마케팅, 알림, 트랜잭션 이메일을 손쉽게 보낼 수 있도록 설계되었다. AWS SES는 높은 전달성, 강력한 인증 기능, 그리고 광범위한 모니터링으로 이메일 관리의 복잡성을 감소시켜 준다.
## 주요 기능
1. 이메일 전송: AWS SES를 사용하면 HTML 또는 일반 텍스트 포맷의 이메일을 전송할 수 있다. 이메일은 개별적으로 또는 대량으로 전송할 수 있다.
2. 이메일 수신: SES는 이메일 수신 기능도 제공한다. 이를 통해 사용자는 SES를 이용해 이메일을 받고, 해당 이메일에 대한 처리 작업을 자동으로 수행할 수 있다.
3. 유연한 이메일 처리: 이메일을 보내고 받는 과정에서 다양한 SNS 토픽(Simple Notification Service)으로 알림을 설정하거나, Lambda 함수를 통해 이메일 내용을 처리하고 분석할 수 있다.
4. SPAM 및 바이러스 필터링: AWS SES는 보내는 이메일에 대해 자동으로 스팸 및 바이러스 필터링을 수행하여, 이메일이 수신자의 정크 폴더로 분류되는 것을 최소화한다.

>**사용법은 따로 작성하지 않아도 될 정도로 쉽다**

## 동시성 제어에서 주문 취소 통보를 할 때 고려해야 할 상황

| 상품명 | 수량   |
| --- | ---- |
| 음료수 | 100개 |

예시)200명의 유저가 동시에 음료수를 1개씩 주문한 상황
1. 100명의 유저는 주문에 성공함
2. 100명의 유저는 주문에 실패함 -> 100명한테 재고가 부족하다고 메일 보냄

이후 상황)
1. 100명의 성공 유저중에서 50명이 결제를 하고 50명은 5분동안 결제를 안해서 취소됨
2. 50명의 유저는 상태가 "결제완료"로 변경
3. 50명의 유저는 상태가 "주문취소"로 변경 -> 50명한테 5분동안 주문을 안해서 취소 됐다고 메일 보냄

| 상품명 | 수량  |
| --- | --- |
| 음료수 | 50개 |

그렇다면 나머지 100명한테 재고가 업데이트 됐다고 메일을 보내야함.
주문은 선착순이라는 것을 공지해야함
## 정리

### 주문 처리 및 알림 흐름

1. **주문 초기 처리**:
    - 200명의 유저가 동시에 음료수를 1개씩 주문한다.
    - 시스템은 분산락을 사용하여 재고를 관리한다.
    - 100명의 유저는 주문에 성공하고, 나머지 100명은 재고 부족으로 주문에 실패한다.
    - 실패한 100명에게는 "재고 부족으로 주문이 실패했다"는 내용의 메일을 발송한다.
2. **결제 처리 및 주문 최종화**:
    - 성공적으로 주문한 100명 중 50명이 결제를 완료한다. 이들의 주문 상태는 "결제완료"로 변경된다.
    - 나머지 50명은 5분 동안 결제를 완료하지 않아 자동으로 주문이 취소된다. 이들의 주문 상태는 "주문취소"로 변경되며, "5분 내에 결제가 완료되지 않아 주문이 취소되었다"는 내용의 메일을 발송한다.
    - 주문 취소로 인해 재고는 다시 50개로 업데이트 된다.
3. **재고 업데이트 알림**:
    - 재고가 업데이트된 사실을 이전에 실패했던 100명의 유저에게 알리며, "재고가 업데이트되었으니 주문이 가능합니다"라는 내용의 메일을 발송한다. 이 메일은 재고가 다시 빨리 소진될 수 있으므로 선착순으로 주문하라는 내용도 포함할 수 있다.
## 해결책
### 주문 상태 추가 제안

현재의 `CANCELLED` 상태는 주문 취소의 일반적인 상황을 포함하지만, 취소의 원인이 다양하므로 추가적인 상태를 도입하는 것이 유용할 수 있다고 생각이 든다. 다음 두 가지 상태를 추가하는 것을 고려할 수 있다:

1. **STOCK_OUT**: 재고 부족으로 인한 주문 취소를 나타낸다.
2. **TIMEOUT**: 결제 시간 초과로 인한 주문 취소를 나타낸다.

### 구현 예시

  
![스크린샷 2024-04-21 오전 1 04 44](https://github.com/pie0902/TIL/assets/47919911/9ecaa1db-0498-4194-9cc5-9b39622d8bf8)


1. **상태 정의**:
    - `NOTPAYED`: 주문이 생성되었으나 아직 결제가 이루어지지 않은 상태.
    - `PREPARING`: 결제가 완료되어 주문 준비 중인 상태.
    - `SHIPPING`: 상품이 배송 중인 상태.
    - `DELIVERED`: 상품이 배송 완료된 상태.
    - `CANCELLED`: 다른 원인으로 인한 일반적인 주문 취소 상태.
    - `STOCK_OUT`: 재고 부족으로 인한 주문 취소 상태.
    - `TIMEOUT`: 결제 시간 초과로 인한 주문 취소 상태.
3. **상태 전환 로직**:
    - 주문 시 `NOTPAYED` 상태로 설정.
    - 5분 내 결제 시 `PREPARING` 상태로 전환.
    - 5분 내에 결제가 이루어지지 않을 경우 `TIMEOUT` 상태로 전환.
    - 재고 부족으로 주문을 받을 수 없는 경우 `STOCK_OUT` 상태로 전환.
4. **알림 메커니즘**:
    - `STOCK_OUT` 상태로 변경 시: "재고 부족으로 주문이 취소되었습니다"라는 내용의 이메일 발송.
    - `TIMEOUT` 상태로 변경 시: "결제 시간 초과로 주문이 취소되었습니다"라는 내용의 이메일 발송.


